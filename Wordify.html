<!--
Introduction to Computer Graphics | Fall 2014 | IIT Gandhinagar
Pankaj Gautam [11110060]
Parth Sane [11110063]
Raj Shah [11110077]
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Wordify</title>
    <!--Title of the HTML page-->
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <div id="main"></div>
	<div id="clockTitle"></div>
    <div id="clock"></div>
    <div id="scoreTitle"></div>
	<div id="score"></div>
    <div id="wordTitle"></div>
	<div id="wordlist"></div>
	<button class="startBtn"type="button" id="startbutton" autofocus="true">START</button>
        
</div>
    <!--Creating an HTML division-->

</head>

<body>
    <script>
    document.getElementById("main").style.height = window.innerHeight + "px"; //Set the height of the main division
    document.getElementById("main").style.width = window.innerWidth + "px"; //Set the width of the main division
    document.getElementById("main").style.top = "0px"; //Position of the main divison
    document.getElementById("main").style.left = "0px";

    document.getElementById("clockTitle").style.height = "34px"; //Set the height of the main division
    document.getElementById("clockTitle").style.width = "150px"; //Set the width of the main division
    document.getElementById("clockTitle").style.top = "10px"; //Position of the main divison
    document.getElementById("clockTitle").style.left = window.innerWidth-150-10 + "px";
    document.getElementById("clockTitle").style.backgroundColor = '#2190c1';
    document.getElementById("clockTitle").innerText = "TIME";

	document.getElementById("clock").style.height = "27px"; //Set the height of the main division
    document.getElementById("clock").style.width = "150px"; //Set the width of the main division
    document.getElementById("clock").style.top = "45px"; //Position of the main divison
    document.getElementById("clock").style.left = window.innerWidth-150-10 + "px";
	document.getElementById("clock").style.backgroundColor = '#1b6d96';
	
    document.getElementById("scoreTitle").style.height = "34px"; //Set the height of the main division
    document.getElementById("scoreTitle").style.width = "150px"; //Set the width of the main division
    document.getElementById("scoreTitle").style.top = "90px"; //Position of the main divison
    document.getElementById("scoreTitle").style.left = window.innerWidth-150-10 + "px";
    document.getElementById("scoreTitle").style.backgroundColor = '#2190c1';
    document.getElementById("scoreTitle").innerText = "SCORE";

    document.getElementById("score").style.height = "27px"; //Set the height of the main division
    document.getElementById("score").style.width = "150px"; //Set the width of the main division
    document.getElementById("score").style.top = "125px"; //Position of the main divison
    document.getElementById("score").style.left = window.innerWidth-150-10 + "px";
	document.getElementById("score").style.backgroundColor = '#1b6d96';
    
    document.getElementById("wordTitle").style.height = "34px"; //Set the height of the main division
    document.getElementById("wordTitle").style.width = "150px"; //Set the width of the main division
    document.getElementById("wordTitle").style.top = "170px"; //Position of the main divison
    document.getElementById("wordTitle").style.left = window.innerWidth-150-10 + "px";
    document.getElementById("wordTitle").style.backgroundColor = '#2190c1';
    document.getElementById("wordTitle").innerText = "WORDS";

	document.getElementById("wordlist").style.height = "425px"; //Set the height of the main division
	document.getElementById("wordlist").style.width = "150px"; //Set the width of the main division
    document.getElementById("wordlist").style.top = "205px"; //Position of the main divison
    document.getElementById("wordlist").style.left = window.innerWidth-150-10 + "px";
	document.getElementById("wordlist").style.backgroundColor = '#1b6d96';
	
	document.getElementById("startbutton").style.height = "50px"; //Set the height of the main division
	document.getElementById("startbutton").style.width = "200px"; //Set the width of the main division
    document.getElementById("startbutton").style.top = window.innerHeight/2-25+"px"; //Position of the main divison
    document.getElementById("startbutton").style.left = window.innerWidth/2-100 + "px";
	
    </script>

    <!--Including all the javascript source files used-->
    <script src="three.js"></script>
    <script src="./gameCube.js"></script>
    <script src="./cubeTexture.js"></script>
    <script src="js/controls/TrackballControls.js"></script>
    <script src="js/libs/stats.min.js"></script>
	<script src="BJSpell.js"></script>
	<script src="jquery-1.9.1.js"></script>
		<script src="fonts/optimer_bold.typeface.js"></script>
		<script src="fonts/optimer_regular.typeface.js"></script>
		
		<script type="application/x-glsl" id="sky-vertex">
varying vec2 vUV;

void main() {
  vUV = uv;
  vec4 pos = vec4(position, 1.0);
  gl_Position = projectionMatrix * modelViewMatrix * pos;
}
</script>

<script type="application/x-glsl" id="sky-fragment">
uniform sampler2D texture;
varying vec2 vUV;

void main() {
  vec4 sample = texture2D(texture, vUV);
  gl_FragColor = vec4(sample.xyz, sample.w);
}
</script>

    <script>
	 //Adding a looking mechanism
    THREE.Utils = {
    cameraLookDir: function(camera) {
        var vector = new THREE.Vector3(0, 0, -1);
        vector.applyEuler(camera.rotation, camera.eulerOrder);
        return vector;
    }
	};
    var mainElement;
    var camera, scene, projector, controls, renderer, plane, allCubes, mouse = new THREE.Vector2();
    var INT = false,	//Boolean variable used for representing intersections
        intCube, intCube1;
    var word = [];
    var camvec = new THREE.Vector3(),r=0, DIS=false;
	var dictionary = new BJSpell("en_US.js");
	var secondscounter=120, minutecounter=2, totalpoints=0;
	var startGame = 0;
    function randLetter() { //Function to return a random letter
        var letters = "AAAAAAAAABBCCDDDDEEEEEEEEEEEEFFGGGHHIIIIIIIIIJKLLLLMMNNNNNNOOOOOOOOPPQRRRRRRSSSSTTTTTTUUUUVVWWXYYZ";
        return letters.substr(Math.floor(Math.random() * 98), 1);
    }
	
			var material1 = new THREE.MeshPhongMaterial({color: 0xffffff});
		var textgeom = new THREE.TextGeometry('wordify',{size:25, height:5,
							curveSegments:4, font:"optimer", weight:"bold",
							style:"normal"});
		 var textMesh = new THREE.Mesh( textgeom, material1 );
    textgeom.computeBoundingBox();
    var textWidth = textgeom.boundingBox.max.x - textgeom.boundingBox.min.x;
    textMesh.position.set( 0-0.5*textWidth,0, -100 );
	
	
    init(); //Calling the init and animate functions
    animate();
	//pausescreen();

    /*function pausescreen(){
        	if(!startGame){
        	camvec.copy(camera.position);
        	camvec.add(THREE.Utils.cameraLookDir(camera).multiplyScalar(750)	);
        	camvec.sub(plane.position);
        	camvec.multiplyScalar(0.3);
			plane.position.add(camvec);
    	    plane.lookAt(camera)
    	}
    	else {
			camvec.copy(camera.position);
        	camvec.add(THREE.Utils.cameraLookDir(camera).multiplyScalar(5000)	);
        	camvec.sub(plane.position);
        	camvec.multiplyScalar(0.003);
			plane.position.add(camvec);
    	    plane.lookAt(camera);
    	}
    }*/
	
    function init() {
        mainElement = document.getElementById("main"); //Get element "main"
        document.body.appendChild(mainElement);
  var clockElement = document.getElementById("clock");
  document.body.appendChild(clockElement);
  addclocktext("clock",minutecounter+":"+((secondscounter%60 < 10) ? ("0" + secondscounter%60) : secondscounter%60));
    var scoreElement = document.getElementById("score");
  document.body.appendChild(scoreElement);
 document.getElementById("score").innerText = "0";
      var wordlistElement = document.getElementById("wordlist");
  document.body.appendChild(wordlistElement);
    document.body.appendChild(wordlistElement);
  var sbuttonElement = document.getElementById("startbutton");
  document.body.appendChild(sbuttonElement);
        camera = new THREE.PerspectiveCamera(45, (window.innerWidth) / window.innerHeight, 1, 10000); //Initializing the camera
        camera.position.z = 250;
        camera.lookAt(new THREE.Vector3(0, 0, 0));


        controls = new THREE.TrackballControls(camera); //Initializing TrackballControls (it uses TrackballControls.js) 
        controls.rotateSpeed = 7;
        controls.zoomSpeed = 2;
        controls.panSpeed = 1;
        controls.staticMoving = true;
		controls.enabled=false;

        var light = new THREE.HemisphereLight(0xffffff, 0xffffff, 1.12); // Create a hemispherical light to show the MeshPhongMaterial objects

        scene = new THREE.Scene(); //Initializing the scene

        var geom = new THREE.CubeGeometry(10, 10, 10); //Geometry to create cubes for letters
        allCubes = new THREE.Object3D(); //3D Object which will have all the cubes
/*		        var hud1geom = new THREE.PlaneGeometry(window.innerWidth,window.innerHeight);
        var hud1mat = new THREE.MeshPhongMaterial( {map: generateplaneTexture(0.40*window.innerWidth,0.50*window.innerHeight)} );
        plane = new THREE.Mesh( hud1geom, hud1mat );
//        var tempvar = new THREE.Vector3();
        camera.rotation.eulerOrder = 'XZY';
        plane.rotation.eulerOrder = 'XZY';

        plane.position.copy(camera.position);
		plane.position.add(THREE.Utils.cameraLookDir(camera).multiplyScalar(750));
        plane.lookAt(camera)
        scene.add( plane );
*/		
		var smaterial = new THREE.MeshPhongMaterial({
                map: generateStartTexture()
            });
			
			var startcube = new MyGameCube(geom, smaterial);

        var i;
        for (i = 0; i < 100; i++) { //Generate 100 random cubes
            var letter = randLetter(); //Get a letter using randLetter function

            //Create a material with texture created by the function defined in CubeTexture.js using the letter as the input
            var material = new THREE.MeshPhongMaterial({
                map: generateTexture(letter)
            });

            //Create a cube with the required attributes using the MyGameCube function defined in MyGameCube.js
            var cube = new MyGameCube(geom, material);

            cube.position.x = (-Math.random() + 0.5) * 150; //Position of the cube
            cube.position.y = (-Math.random() + 0.5) * 150;
            cube.position.z = (-Math.random() + 0.5) * 150;

            cube.rotation.x = 2 * Math.PI * (-Math.random() + 0.5); //Rotation of the cube
            cube.rotation.y = 2 * Math.PI * (-Math.random() + 0.5);
            cube.rotation.z = 2 * Math.PI * (-Math.random() + 0.5);

            cube.letter = letter; //Assign the letter to this cube
            allCubes.add(cube); //Add the cube to allCubes
        }
        //scene.add(allCubes); //Add allCubes to the scene
		

		scene.add(textMesh);
        scene.add(light); //Add light to the scene
		
			/*var imagePrefix = "images/dawnmountain-";
	var directions  = ["xpos", "xneg", "ypos", "yneg", "zpos", "zneg"];
	var imageSuffix = ".png";
	var skyGeometry = new THREE.CubeGeometry( 5000, 5000, 5000 );	
	
	var materialArray = [];
	THREE.ImageUtils.crossOrigin = '';
	for (var i = 0; i < 6; i++)
		materialArray.push( new THREE.MeshBasicMaterial({
			map: THREE.ImageUtils.loadTexture("http://i.imgur.com/KIYRScN.jpg" ),
			side: THREE.BackSide
		}));
	var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
	var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
	scene.add( skyBox );*/
	
	var skygeometry = new THREE.SphereGeometry(750, 6, 4);
	THREE.ImageUtils.crossOrigin = '';
var uniforms = {
  texture: { type: 't', value: THREE.ImageUtils.loadTexture('http://i.imgur.com/gcKQsM1.jpg') }
};

var skymaterial = new THREE.ShaderMaterial( {
  uniforms:       uniforms,
  vertexShader:   document.getElementById('sky-vertex').textContent,
  fragmentShader: document.getElementById('sky-fragment').textContent
});

skyBox = new THREE.Mesh(skygeometry, skymaterial);
skyBox.scale.set(-1, 1, 1);
skyBox.eulerOrder = 'XZY';
skyBox.renderDepth = 1000.0;
scene.add(skyBox);

        projector = new THREE.Projector(); //Create a new projector

        renderer = new THREE.WebGLRenderer({
            antialias: true
        }); //Create a new renderer
        renderer.setClearColor(0xF0F0FF); //Set the renderer color
        renderer.setSize(window.innerWidth, window.innerHeight); //Set the renderer size

        mainElement.appendChild(renderer.domElement); //Append the renderer element to the main element

        stats = new Stats(); //Create a stats object using Stats function in Stats.js
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        mainElement.appendChild(stats.domElement); //Append the stats element to the main element
		
        renderer.domElement.addEventListener('mousemove', onDocumentMouseMove, false); //Add Mouse Move event listener
        renderer.domElement.addEventListener('click', onDocumentMouseDown, false);
        window.addEventListener('keydown', onDocumentKeyDown, false); //Add Key Down event listener
        window.addEventListener('resize', onWindowResize, false);
		  sbuttonElement.onclick = function(){
  	        if(startGame==0){
			controls.enabled = true;
			startGame = !startGame;
			sbuttonElement.remove();
        	scene.add(allCubes);
			var mytimer = window.setInterval(function(){timer()}, 1000);
        }
  }
    }

    function onDocumentMouseMove(event) {
        event.preventDefault();
        //Mouse Position
        mouse.x = ((event.clientX - renderer.domElement.offsetLeft) / renderer.domElement.width) * 2 - 1;
        mouse.y = -((event.clientY - renderer.domElement.offsetTop) / renderer.domElement.height) * 2 + 1;

        var mousevect = new THREE.Vector3(mouse.x, mouse.y, 0.5); //Mouse Vector
        projector.unprojectVector(mousevect, camera); //Unproject mouse vector using camera
        //Cast a ray from camera position towards mouse position 
        var raycaster = new THREE.Raycaster(camera.position, mousevect.sub(camera.position).normalize());
        var intersects = raycaster.intersectObjects(allCubes.children); //Get an array of objects that intersect the ray

        allCubes.children.forEach(function(cube) {
            if (!cube.isSelected) cube.material.color.setHex(0xffffff);
        }); //Update the color of the cubes 

        if (intersects.length > 0 && !intersects[0].object.isSelected) {

            intersects[0].object.material.color.setHex(0xC7F464); //Change the color of the nearest intersecting cube
            mainElement.style.cursor = 'pointer'; //Change the mouse pointer
            INT = true;
            intCube = intersects[0].object; //Assign first cube to intCube
        } else {
            INT = false;
            mainElement.style.cursor = 'auto';
        }

    }

    function onDocumentMouseDown(event) {
        event.preventDefault();
        mouse.x = ((event.clientX - renderer.domElement.offsetLeft) / renderer.domElement.width) * 2 - 1;
        mouse.y = -((event.clientY - renderer.domElement.offsetTop) / renderer.domElement.height) * 2 + 1;
	
        var mousevect = new THREE.Vector3(mouse.x, mouse.y, 0.5);
        projector.unprojectVector(mousevect, camera);
        var raycaster = new THREE.Raycaster(camera.position, mousevect.sub(camera.position).normalize());
        var intersects = raycaster.intersectObjects(allCubes.children);

        if (intersects.length > 0) {
            intCube = intersects[0].object;
            if (!intCube.isSelected) {
                intersects[0].object.material.color.setHex(0xC44D58); //Change color on Selection
                intersects[0].object.material.opacity = 1.5;
                mainElement.style.cursor = 'pointer';
                INT = false;
                intCube.isSelected = 1; //Change the selected flag on selection
                word.push(intCube); //Push the selected cubes to a dynamic array
            }
        }

    }

    function onDocumentKeyDown(event) {
        if (event.keyCode == 80){
        	startGame = !startGame;
        	if(!startGame){
        		scene.remove(allCubes);
        	}
        	else{
	        	scene.add(allCubes);
        	}
        	
        }
        else if (event.keyCode == 86){

            allCubes.visible = !allCubes.visible;
        }
        else if (event.keyCode == 13) { //Keycode for Enter
            var currentWord = '';
            var totpot = 0;
            for (i = 0; i < word.length; i++) {
                //Extract the letters and points from the selected cubes to create a word and calculate the total points 
                currentWord = currentWord + word[i].letter;
                totpot = totpot + word[i].points();
            }
			if (dictionary.check(currentWord.toLowerCase()) && currentWord.length>2){
			for (i = 0; i < word.length; i++) {
			allCubes.remove(word[i]);
			}
			if (currentWord.length>=3 && currentWord.length<=5) totalpoints=totalpoints+totpot*50;
			else if (currentWord.length>=6 && currentWord.length<=8) totalpoints=totalpoints+totpot*75;
			else if  (currentWord.length>=9 && currentWord.length<=10) totalpoints=totalpoints+totpot*100;
			else if (currentWord.length>10) totalpoints=totalpoints+totpot*125
			addscoretext("score", totalpoints);
			addword("wordlist",currentWord);
			//alert("Word:" + currentWord + "  Points:" + totpot); //Show the extracted word and total points
			}
			else{
			for (i = 0; i < word.length; i++) {
                //Deselect the selected cubes
                word[i].isSelected = 0;
            }
            while (word.length != 0) {
                word.pop(); //Reset the dynamic array
            }
            allCubes.children.forEach(function(cube) {
                if (!cube.isSelected) cube.material.color.setHex(0xffffff);
            }); //Update the color
			alert("Invalid Word");
			}
            while (word.length != 0) {
                word.pop(); //Reset the dynamic array
            }

        }
        if (event.keyCode == 8) { //Keycode for Backspace
            for (i = 0; i < word.length; i++) {
                //Deselect the selected cubes
                word[i].isSelected = 0;
            }
            while (word.length != 0) {
                word.pop(); //Reset the dynamic array
            }
            allCubes.children.forEach(function(cube) {
                if (!cube.isSelected) cube.material.color.setHex(0xffffff);
            }); //Update the color
        }
    }
	
	function addclocktext(element, text){
	    var myelement = document.getElementById(element);
		myelement.innerText = text;
	}
		function addscoretext(element, text){
	    var myelement = document.getElementById(element);
		myelement.innerText = text;
	}
	function addword(element, text){
	    var myelement = document.getElementById(element);
		myelement.innerText =text + "\n" + myelement.innerText;
	}

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }
	function timer() {
	if (minutecounter!=0 || secondscounter!=0) 
	{
	if ( (secondscounter%60) == 0) {
    minutecounter = minutecounter - 1;}
	secondscounter = secondscounter - 1;
	addclocktext("clock",minutecounter+":"+((secondscounter%60 < 10) ? ("0" + secondscounter%60) : secondscounter%60));
	}
	else {
	while (allCubes.children.length != 0) {
                allCubes.remove(allCubes.children[allCubes.children.length-1]); //Reset the dynamic array
            }
	scene.remove(allCubes);
	var mytimer = window.setInterval(function(){timer()}, 1000);
	window.clearInterval(mytimer);
	}
	}
	
	function display(){
	document.getElementById("clock").style.display = 'block';
	document.getElementById("wordlist").style.display = 'block';
	document.getElementById("score").style.display = 'block';
	document.getElementById("startbutton").style.display = 'block';
    document.getElementById("clockTitle").style.display = 'block';
    document.getElementById("scoreTitle").style.display = 'block';
    document.getElementById("wordTitle").style.display = 'block';
	}
	
    function animate() { //Animate function

        requestAnimationFrame(animate);

        render();
		if (r==126) {
		display();
		r=r+1;
		} 
        stats.update(); //Update the stats

    }

    function render() {
		//pausescreen();
		/*plane.rotation.x = camera.rotation.x;
        plane.rotation.y = camera.rotation.y;
        plane.rotation.z = camera.rotation.z;*/
        controls.update(); //Update the controls
        renderer.render(scene, camera); //Render the scene and camera
		if (r<=125) {
		textMesh.position.set( 0-0.5*textWidth,0, -700+Math.sqrt(r)*r/1.5 );
		r=r+1;}
		if (r==126) {
		scene.remove(textMesh);
		}
        if (INT) { //Rotate the cube on intersection
            intCube.rotation.x += 0.05;
            intCube.rotation.y += 0.02;
            intCube.rotation.z += 0.03;
        }
    }
    </script>

</body>

</html>
